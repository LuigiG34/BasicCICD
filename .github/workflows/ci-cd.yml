name: CI/CD (Hostinger LiteSpeed)

on:
  push:
    branches: [ "master" ]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, pdo_sqlite
          tools: composer:v2

      - name: Install dev dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run tests (SQLite)
        env:
          APP_ENV: test
          SYMFONY_DEPRECATIONS_HELPER: weak
        run: ./vendor/bin/phpunit -v

  deploy:
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP for build
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl
          tools: composer:v2

      - name: Install prod dependencies
        run: composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      - name: Deploy via rsync (manual)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY:  ${{ secrets.SSH_KEY }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y rsync

          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${SSH_PORT:-22}" "$SSH_HOST" >> ~/.ssh/known_hosts

          rsync -az --delete \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="var/cache/*" \
            --exclude="var/log/*" \
            --exclude=".env" \
            --exclude=".env.test" \
            --exclude=".env.local" \
            -e "ssh -i ~/.ssh/id_ed25519 -p ${SSH_PORT:-22}" \
            ./ "${SSH_USER}@${SSH_HOST}:${REMOTE_PATH}"

      - name: Post-deploy on server (DB debug)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -eux
            cd "${{ secrets.REMOTE_PATH }}"

            # Write .env.local safely
            cat > .env.local <<'EOF'
            APP_ENV=prod
            APP_DEBUG=0
            APP_SECRET=${{ secrets.APP_SECRET }}
            DATABASE_URL="mysql://${{ secrets.DB_USER }}:${{ secrets.DB_PASS }}@${{ secrets.DB_HOST }}:3306/${{ secrets.DB_NAME }}?charset=utf8mb4"
            EOF

            php -v
            php -m | sort

            # File-based PDO test with immediate output
            cat > /tmp/pdo_test.php <<'PHP'
            <?php
            error_reporting(E_ALL); ini_set('display_errors', 1);
            $host = getenv('DB_HOST'); $db = getenv('DB_NAME'); $user = getenv('DB_USER'); $pass = getenv('DB_PASS');
            
            echo "=== PDO CONNECTION TEST ===\n";
            echo "Host: $host\n";
            echo "Database: $db\n";
            echo "User: $user\n";
            echo "Password length: " . strlen($pass) . "\n";
            
            $dsn = "mysql:host=$host;dbname=$db;charset=utf8mb4";
            echo "DSN: $dsn\n\n";
            
            try {
              $pdo = new PDO($dsn, $user, $pass, [
                PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                PDO::ATTR_TIMEOUT => 5
              ]);
              echo "✅ PDO connection successful!\n";
              $version = $pdo->query('SELECT VERSION()')->fetchColumn();
              echo "MySQL version: $version\n";
              exit(0);
            } catch (PDOException $e) {
              echo "❌ PDO FAILED: " . $e->getMessage() . "\n";
              echo "Error code: " . $e->getCode() . "\n";
              exit(2);
            } catch (Throwable $e) {
              echo "❌ UNEXPECTED ERROR: " . $e->getMessage() . "\n";
              exit(3);
            }
            PHP

            echo "==== Running PDO Test ===="
            DB_HOST='${{ secrets.DB_HOST }}' \
            DB_NAME='${{ secrets.DB_NAME }}' \
            DB_USER='${{ secrets.DB_USER }}' \
            DB_PASS='${{ secrets.DB_PASS }}' \
              php /tmp/pdo_test.php
            echo "==== PDO Test Complete ===="

            test -f bin/console || { echo "❌ bin/console missing"; exit 1; }
            APP_DEBUG=1 php -d display_errors=1 bin/console about --env=prod -vvv
            php bin/console cache:clear --env=prod -vvv
            php bin/console cache:warmup --env=prod -vvv
            php bin/console doctrine:schema:update --force --env=prod -vvv